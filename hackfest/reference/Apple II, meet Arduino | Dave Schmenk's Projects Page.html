<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) | !(IE 8) ]><!-->
<html lang="en-US"><!--<![endif]--><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Apple II, meet Arduino | Dave Schmenk's Projects Page</title>
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="http://schmenk.is-a-geek.com/wordpress/xmlrpc.php">
	<!--[if lt IE 9]>
	<script src="http://schmenk.is-a-geek.com/wordpress/wp-content/themes/twentyfourteen/js/html5.js"></script>
	<![endif]-->
	<link rel="dns-prefetch" href="http://fonts.googleapis.com/">
<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Dave Schmenk's Projects Page » Feed" href="http://schmenk.is-a-geek.com/wordpress/?feed=rss2">
<link rel="alternate" type="application/rss+xml" title="Dave Schmenk's Projects Page » Comments Feed" href="http://schmenk.is-a-geek.com/wordpress/?feed=comments-rss2">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/schmenk.is-a-geek.com\/wordpress\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.5"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/wp-emoji-release.js" type="text/javascript" defer="defer"></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="twentyfourteen-lato-css" href="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/css.css" type="text/css" media="all">
<link rel="stylesheet" id="genericons-css" href="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/genericons.css" type="text/css" media="all">
<link rel="stylesheet" id="twentyfourteen-style-css" href="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/style.css" type="text/css" media="all">
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentyfourteen-ie-css'  href='http://schmenk.is-a-geek.com/wordpress/wp-content/themes/twentyfourteen/css/ie.css?ver=20131205' type='text/css' media='all' />
<![endif]-->
<script type="text/javascript" src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/jquery.js"></script>
<script type="text/javascript" src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/jquery-migrate.js"></script>
<link rel="https://api.w.org/" href="http://schmenk.is-a-geek.com/wordpress/?rest_route=/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://schmenk.is-a-geek.com/wordpress/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://schmenk.is-a-geek.com/wordpress/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="Apple II Web Server" href="http://schmenk.is-a-geek.com/wordpress/?p=216">
<link rel="next" title="Apple II + Arduino + SD Card + SdFat = A2SdFat!" href="http://schmenk.is-a-geek.com/wordpress/?p=239">
<meta name="generator" content="WordPress 4.7.5">
<link rel="canonical" href="http://schmenk.is-a-geek.com/wordpress/?p=233">
<link rel="shortlink" href="http://schmenk.is-a-geek.com/wordpress/?p=233">
<link rel="alternate" type="application/json+oembed" href="http://schmenk.is-a-geek.com/wordpress/?rest_route=%2Foembed%2F1.0%2Fembed&amp;url=http%3A%2F%2Fschmenk.is-a-geek.com%2Fwordpress%2F%3Fp%3D233">
<link rel="alternate" type="text/xml+oembed" href="http://schmenk.is-a-geek.com/wordpress/?rest_route=%2Foembed%2F1.0%2Fembed&amp;url=http%3A%2F%2Fschmenk.is-a-geek.com%2Fwordpress%2F%3Fp%3D233&amp;format=xml">
</head>

<body class="post-template-default single single-post postid-233 single-format-standard masthead-fixed full-width singular">
<div id="page" class="hfeed site">
	
	<header id="masthead" class="site-header" role="banner">
		<div class="header-main">
			<h1 class="site-title"><a href="http://schmenk.is-a-geek.com/wordpress/" rel="home">Dave Schmenk's Projects Page</a></h1>

			<div class="search-toggle">
				<a href="#search-container" class="screen-reader-text">Search</a>
			</div>

			<nav id="primary-navigation" class="site-navigation primary-navigation" role="navigation">
				<h1 class="menu-toggle">Primary Menu</h1>
				<a class="screen-reader-text skip-link" href="#content">Skip to content</a>
				<div class="nav-menu"><ul>
<li class="page_item page-item-2"><a href="http://schmenk.is-a-geek.com/wordpress/?page_id=2">About</a></li>
<li class="page_item page-item-45"><a href="http://schmenk.is-a-geek.com/wordpress/?page_id=45">Car Toys, Past and Present</a></li>
</ul></div>
			</nav>
		</div>

		<div id="search-container" class="search-box-wrapper hide">
			<div class="search-box">
				<form role="search" method="get" class="search-form" action="http://schmenk.is-a-geek.com/wordpress/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search …" name="s">
				</label>
				<input type="submit" class="search-submit" value="Search">
			</form>			</div>
		</div>
	</header><!-- #masthead -->

	<div id="main" class="site-main">

	<div id="primary" class="content-area">
		<div id="content" class="site-content" role="main">
			
<article id="post-233" class="post-233 post type-post status-publish format-standard hentry category-apple-ii category-arduino category-hardware category-software">
	
	<header class="entry-header">
				<div class="entry-meta">
			<span class="cat-links"><a href="http://schmenk.is-a-geek.com/wordpress/?cat=9" rel="category">Apple II</a>, <a href="http://schmenk.is-a-geek.com/wordpress/?cat=11" rel="category">Arduino</a>, <a href="http://schmenk.is-a-geek.com/wordpress/?cat=8" rel="category">Hardware</a>, <a href="http://schmenk.is-a-geek.com/wordpress/?cat=7" rel="category">Software</a></span>
		</div>
		<h1 class="entry-title">Apple II, meet Arduino</h1>
		<div class="entry-meta">
			<span class="entry-date"><a href="http://schmenk.is-a-geek.com/wordpress/?p=233" rel="bookmark"><time class="entry-date" datetime="2016-08-10T13:58:04+00:00">August 10, 2016</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="http://schmenk.is-a-geek.com/wordpress/?author=1" rel="author">dave</a></span></span>		</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>Having received a package in the mail last week containing Andrew 
and Ivan Hogan’s GamePort I/O Board, it got my creative juices flowing. 
The <a title="Ivan Hogan's KFest Presentation" href="http://www.ivanhogan.com/kfest/" target="_blank">GamePort I/O Board</a>&nbsp;is
 a great interface to big, external devices. It’s meant to control 
things like electronic sprinkler heads, relays, that sort of thing. I 
wrote a PLASMA sketch to simplify the game port interface, and generally
 had fun with it. But, as I sat there looking at the game port 
specification in the Apple II Reference Manual, I noted a utility strobe
 signal that would produce a 1/2 micro-second pulse when referenced. 
Hmm. In years past, I had tried building an SPI (Serial Interface Bus) 
connection using a 6522 and external shift register so I could adapt an 
Arduino Ethernet Shield to the Apple II. It almost worked, but not 
quite. And not too long ago, Charles Mangin of Option8 fame had brought 
up for discussion a method of talking to an Arduino over the Apple II’s 
game port, and a <a title="GP2IO" href="https://github.com/option8/gp2io" target="_blank">KansasFest presentation</a>
 to match. All of this must have sunk into my sub conscience, because I 
actually had a dream about how to bit-bang an SPI interface from the 
Apple II to an Arduino over the game port.</p>
<p>Why SPI? Well, it is a nicely defined protocol that has some interesting properties. More information can be found on&nbsp;<a title="Serial Interface Bus" href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus" target="_blank">WikiPedia</a>,
 but it boils down to having a master talking to a slave in a 
synchronous manner. Data travels both ways: a bit is read as one is 
written. So you read and write at the same time. Not all data need be 
relevant, however. SPI doesn’t define a high-level protocol, just a 
transfer mechanism. &nbsp;And it only requires 4 wires: SlaveSelect, 
Clock, MasterOut/SlaveIn, and MasterIn/SlaveOut.</p>
<p>The Apple II game port isn’t the greatest interface for implementing a
 fast bit-banged protocol, but it isn’t too bad, either.&nbsp;The master
 is responsible for the clock, which is where that utility strobe comes 
in. Along with the strobe, it has 4 general purpose digital outputs and 3
 general purpose digital inputs. Programming the outputs is a little 
strange, and somewhat time consuming on a 6502 if you want to scan out a
 series of bits. For SPI, only two outputs are needed and one input, if 
the strobe is used as the clock. This is where the strobe signal really 
helps out with the bit-banging approach. The clock signal doesn’t have 
to be symmetrical, the slave just wants to see the edges, and it doesn’t
 have to adhere to a consistent rate (although I assume most hardware 
implementations are). So that takes care of the Apple II side of things.
 What about the Arduino?</p>
<p>SPI on the Arduino is officially only supported in master mode. If I 
was going to bit-bang the interface on the Apple II, why not the 
Arduino. One of my goals was to leave the hardware SPI interface on the 
Arduino intact so I could use the Arduino as a proxy for the Apple II 
when talking to the myriad of Arduino shields out there – many of which 
talk SPI. On top of that, there are some nice libraries that implement 
higher level interfaces such as TCP/IP and FAT file systems. Now the 
Arduino Uno (well, the ATmega 328P) has some nice features for 
interfacing to all sorts of things, and the Arduino IDE is a great 
prototyping environment, so it did’t take long to whip up a connection 
between the Apple II game port and the digital pins on the Uno. It did 
take a few iterations to identify the best way to interrupt the 328P 
when the Apple II was initiating a transaction. Software polling was 
going to be slow, and potentially miss the quick clock pulses. So I 
connected the clock signal to an interrupt to make sure I didn’t miss 
any. However, there was enough potential jitter in servicing the 
interrupt that bits could get lost. So I ended up interrupting on the 
assertion of SlaveSelect, and went into a tight loop watching the clock 
signal and updating the shift registers. Because of the tight 
constraints during data transmission, I skipped the Wiring library and 
went straight to the I/O ports on the 328P. By choosing my pins wisely, 
it made the software particularly simple to shift data in and out over 
the wires.</p>
<p>Testing out the wiring options was made easier by using a breadboard to connect the game port to the Arduino’s header.</p>
<p><a href="http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2321.jpg"><img class="aligncenter size-medium wp-image-229" alt="Breadboard Connection" src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/IMG_2321-225x300.jpg" srcset="http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2321-225x300.jpg 225w, http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2321.jpg 480w" sizes="(max-width: 225px) 100vw, 225px" width="225" height="300"></a>Switching the pins around was a matter of moving the wire.</p>
<p>Finally, I came to a conclusion as to the best wiring connections:</p>
<pre> Apple II        Signal         Arduino
 --------        ------         -------
   AN0            MOSI        Digital Pin 8
C040 Strobe       SCK         Digital Pin 6  
   AN1             SS         Digital Pin 3
   PB0            MISO        Digital Pin 7</pre>
<p>Once I was satisfied the interface was solid, I soldered up my one 
and only Arduino Proto Shield, which was waiting for just the perfect 
project to commit to.</p>
<p><a href="http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2322.jpg"><img class="aligncenter size-medium wp-image-230" alt="IMG_2322" src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/IMG_2322-300x225.jpg" srcset="http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2322-300x225.jpg 300w, http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2322.jpg 640w" sizes="(max-width: 300px) 100vw, 300px" width="300" height="225"></a>I soldered the wires to the back to keep it nice and clean.</p>
<p><a href="http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2325.jpg"><img class="aligncenter size-medium wp-image-232" alt="IMG_2325" src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/IMG_2325-300x225.jpg" srcset="http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2325-300x225.jpg 300w, http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2325.jpg 640w" sizes="(max-width: 300px) 100vw, 300px" width="300" height="225"></a>The
 game port does have a 5V supply, but it is very limited in current: 
100mA. A base Arduino without much load should be able to keep under 
that requirement, but when connected to a host PC for programming, I 
didn’t want my 5V supplies fighting each other, so I added a jumper for 
the game port’s 5V. &nbsp;The Arduino site says this isn’t recommended. 
Yeah, whatever. &nbsp;Finally, it all came together and I ran my test 
program on it.</p>
<p><a href="http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2323.jpg"><img class="aligncenter size-medium wp-image-231" alt="IMG_2323" src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/IMG_2323-300x225.jpg" srcset="http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2323-300x225.jpg 300w, http://schmenk.is-a-geek.com/wordpress/wp-content/uploads/2016/08/IMG_2323.jpg 640w" sizes="(max-width: 300px) 100vw, 300px" width="300" height="225"></a>The
 LED lights up whenever a key is pressed on the keyboard that has the 
LSB set, or turns the LED off when it doesn’t. The Arduino’s on-board 
LED was somewhat covered up by the Proto Shield, so I plugged another 
one right into the header so you could see it. You can find the Arduino 
sketch and the PLASMA sketch on <a title="Apple SPI Slave" href="https://github.com/dschmenk/Arduino/tree/master/AppleSlave" target="_blank">GitHub</a>.</p>
<p>Going forward, I would like to leverage the FAT filesystem library 
for SD cards so I can read and write files to and from the Apple II 
directly from the card. That will greatly simplify my file transfer 
workflow.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
	</div><!-- .entry-content -->
	
	</article><!-- #post-## -->
	<nav class="navigation post-navigation" role="navigation">
		<h1 class="screen-reader-text">Post navigation</h1>
		<div class="nav-links">
			<a href="http://schmenk.is-a-geek.com/wordpress/?p=216" rel="prev"><span class="meta-nav">Previous Post</span>Apple II Web Server</a><a href="http://schmenk.is-a-geek.com/wordpress/?p=239" rel="next"><span class="meta-nav">Next Post</span>Apple II + Arduino + SD Card + SdFat = A2SdFat!</a>		</div><!-- .nav-links -->
	</nav><!-- .navigation -->
			</div><!-- #content -->
	</div><!-- #primary -->

<div id="secondary">
		<h2 class="site-description">My projects to amuse and confound</h2>
	
	
	</div><!-- #secondary -->

		</div><!-- #main -->

		<footer id="colophon" class="site-footer" role="contentinfo">

			
			<div class="site-info">
								<a href="http://wordpress.org/">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- #colophon -->
	</div><!-- #page -->

	<script type="text/javascript" src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/functions.js"></script>
<script type="text/javascript" src="Apple%20II,%20meet%20Arduino%20|%20Dave%20Schmenk's%20Projects%20Page_files/wp-embed.js"></script>

</body></html>